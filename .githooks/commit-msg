#!/bin/bash
#
# Validate commit messages follow Conventional Commits format
# https://www.conventionalcommits.org/
#

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Conventional commit regex pattern
# Matches: type(scope)!: description OR type!: description OR type: description
pattern="^(feat|fix|perf|docs|style|refactor|test|chore|ci|build|revert)(\([a-zA-Z0-9_-]+\))?(!)?: .+"

# Skip merge commits
if [[ "$commit_msg" =~ ^Merge ]]; then
    exit 0
fi

# Skip if message starts with fixup! or squash! (for interactive rebase)
if [[ "$commit_msg" =~ ^(fixup|squash)! ]]; then
    exit 0
fi

# Get the first line (subject)
subject=$(echo "$commit_msg" | head -n1)

# Validate against pattern
if [[ ! "$subject" =~ $pattern ]]; then
    echo -e "${RED}ERROR: Invalid commit message format${NC}"
    echo ""
    echo -e "Your message: ${YELLOW}$subject${NC}"
    echo ""
    echo "Commit messages must follow Conventional Commits format:"
    echo -e "  ${GREEN}<type>[optional scope]: <description>${NC}"
    echo ""
    echo "Valid types:"
    echo -e "  ${GREEN}feat${NC}     - New feature (appears in changelog)"
    echo -e "  ${GREEN}fix${NC}      - Bug fix (appears in changelog)"
    echo -e "  ${GREEN}perf${NC}     - Performance improvement (appears in changelog)"
    echo -e "  docs     - Documentation only"
    echo -e "  style    - Formatting, whitespace"
    echo -e "  refactor - Code restructuring"
    echo -e "  test     - Adding/updating tests"
    echo -e "  chore    - Maintenance tasks"
    echo -e "  ci       - CI/CD changes"
    echo -e "  build    - Build system changes"
    echo ""
    echo "Examples:"
    echo -e "  ${GREEN}feat: Add user authentication${NC}"
    echo -e "  ${GREEN}fix(scanner): Resolve crash on empty dirs${NC}"
    echo -e "  ${GREEN}feat!: Redesign plugin API${NC} (breaking change)"
    echo ""
    exit 1
fi

# Check description isn't empty
description=$(echo "$subject" | sed -E 's/^[a-z]+(\([^)]+\))?(!)?: //')
if [[ -z "$description" || "$description" == " " ]]; then
    echo -e "${RED}ERROR: Commit message must have a description after the type${NC}"
    exit 1
fi

# Check description doesn't start with capital letter (convention)
if [[ "$description" =~ ^[A-Z] ]]; then
    echo -e "${YELLOW}WARNING: Description should start with lowercase letter${NC}"
    echo -e "Your description: ${description}"
    # This is just a warning, not a hard failure
fi

# Check description doesn't end with period
if [[ "$description" =~ \.$ ]]; then
    echo -e "${YELLOW}WARNING: Description should not end with a period${NC}"
    # This is just a warning, not a hard failure
fi

echo -e "${GREEN}Commit message is valid${NC}"
exit 0
